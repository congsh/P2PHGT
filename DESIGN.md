# P2P海龟汤在线房间 - 设计文档

## 1. 项目概述

### 1.1 项目名称
P2P海龟汤在线房间 (P2P Sea Turtle Soup Room)

### 1.2 核心理念
本项目旨在创建一个基于WebRTC技术的网页版海龟汤游戏。它无需中心服务器，玩家通过P2P（点对点）方式直接连接，保证了私密性和低延迟。主持人作为房间的"主机"，负责创建游戏、分发邀请并管理游戏进程。

### 1.3 目标用户
希望和朋友们进行一场私密、便捷、无需注册下载的海龟汤游戏的用户群体。

---

## 2. 功能需求

### 2.1 核心玩法

#### 2.1.1 角色系统
- **主持人 (Host):**
    - 房间的创建者和游戏的核心。
    - 负责设定游戏规则、出题（汤面和汤底）。
    - 生成"邀请码"分享给参与者。
    - 接收参与者的"响应码"以建立P2P连接。
    - 拥有游戏控制权：通过【是】【否】【不确定】按钮回答问题、发布情报、管理提问者、结束游戏。
    - 是所有数据广播的中心节点。

- **参与者 (Participant):**
    - 通过主持人分享的"邀请码"加入游戏。
    - 生成"响应码"发送给主持人以完成连接。
    - 主要操作为向主持人进行文字提问。
    - 拥有独立的个人笔记区，用于记录线索。
    - 可根据规则进行举手、送花等互动。

#### 2.1.2 游戏流程
1.  **创建房间:** 用户选择"创建房间"成为主持人。
2.  **设定规则:** 主持人设定本次游戏的规则，并写下汤面和汤底。
3.  **生成邀请:** 系统为主持人生成一个加密的"邀请码"（包含了P2P连接信息和房间规则）。
4.  **分发邀请:** 主持人通过站外聊天工具将邀请码发送给朋友。
5.  **加入房间:** 参与者在页面粘贴邀请码，点击"加入房间"。
6.  **响应连接:** 系统为参与者生成一个"响应码"。
7.  **建立连接:** 参与者将响应码发回给主持人，主持人粘贴后，两者建立直接的P2P连接。主持人为每一位参与者重复此操作。
8.  **开始游戏:** 所有玩家就位后，主持人宣布游戏开始。游戏信息（如提问、回答、情报）由主持人广播给所有参与者。
9.  **结束游戏:** 主持人点击"结束游戏"，公布汤底，游戏结束。

#### 2.1.3 规则设定（由主持人创建时确定）
- **汤底类型:** 红汤 / 非红汤 (作为内容提示)。
- **提问模式:**
    - **自由模式:** 参与者可随时提问。
    - **举手模式:** 参与者需"举手"申请，由主持人"点名"后方可提问。
- **互动功能:** 允许 / 禁止 参与者之间互丢鲜花或垃圾。

---

### 2.2 用户界面 (UI)

#### 2.2.1 主持人视图
- **房间设置区:** 用于输入汤面、汤底和选择游戏规则。
- **连接管理区:**
    - 显示并一键复制"邀请码"。
    - 输入框，用于粘贴参与者的"响应码"。
    - 已连接的参与者列表。
- **游戏控制区:**
    - 【是】、【否】、【不确定】三个回答按钮。
    - "发布情报"输入框和按钮。
    - "结束游戏"按钮。
    - （举手模式下）举手列表和"点名"按钮。
- **聊天记录区:** 显示所有公开的提问、回答和情报。

#### 2.2.2 参与者视图
- **加入房间界面:** 输入"邀请码"的文本框。
- **等待连接界面:** 显示生成的"响应码"和一键复制按钮。
- **游戏主界面:**
    - **提问区:** 文字输入框和"发送"按钮。
    - **互动区:** （举手模式下）"举手"按钮；（如规则允许）"送鲜花/垃圾"按钮。
    - **聊天记录区:** 与主持人视图同步。
    - **个人笔记区:** 一个私密的富文本或纯文本区域，用于自由记录。
    - **房间信息区:** 显示当前房间规则和在线玩家列表。

---

## 3. 技术设计

### 3.1 技术栈
- **核心框架:** Vanilla JavaScript (无前端框架，保持轻量)。
- **P2P通信:** `simple-peer` (一个对WebRTC的友好封装)。
- **UI/UX:** HTML5, CSS3。
- **辅助库:** `clipboard.js` (用于一键复制功能)。

### 3.2 网络拓扑
- **星型网络 (Star Network):**
    - 主持人作为中心枢纽 (Hub)。
    - 所有参与者 (Spokes) 只与主持人建立连接。
    - 任何需要广播的消息（如提问、回答）都由参与者发给主持人，再由主持人转发给其他所有参与者。
    - **优点:** 逻辑简单清晰，状态由主持人统一管理，避免了多对多连接的复杂性。

### 3.3 数据协议
所有在对等连接上传输的数据都应是JSON格式的字符串，以利于解析和扩展。

- **消息基本结构:** `{ "type": "...", "payload": {...} }`

- **`type` (消息类型) 定义:**
    - `C2H_QUESTION`: (参与者->主持) 提问。
        - `payload: { content: "提问内容" }`
    - `H2A_QUESTION_RELAY`: (主持->所有参与者) 转发收到的提问。
        - `payload: { from: "提问者昵称", content: "提问内容" }`
    - `H2A_ANSWER`: (主持->所有参与者) 回答问题。
        - `payload: { answer: "yes" | "no" | "uncertain" }`
    - `H2A_CLUE`: (主持->所有参与者) 发布情报。
        - `payload: { content: "情报内容" }`
    - `H2A_GAME_STATE`: (主持->所有参与者) 同步完整的游戏状态（如新玩家加入时）。
        - `payload: { rules: {...}, participants: [...], history: [...] }`
    - `C2H_INTERACTION`: (参与者->主持) 用户互动（举手、送花等）。
        - `payload: { type: "raise_hand" | "throw_flower", ... }`
    - `H2A_INTERACTION_RELAY`: (主持->所有参与者) 转发互动事件。
    - `H2A_GAME_END`: (主持->所有参与者) 游戏结束。
        - `payload: { solution: "汤底" }`

---

## 4. 项目里程碑

### 里程碑一: 核心连接与消息功能 (MVP)
- **目标:** 实现主持人与单个参与者之间的P2P连接和基本文本消息互通。
- **任务:**
    1.  搭建HTML基本页面结构（一个页面，通过js切换不同视图）。
    2.  集成 `simple-peer` 库。
    3.  实现"邀请码"和"响应码"的生成、复制、粘贴流程。
    4.  建立连接后，可以双向发送简单文本消息。

### 里程碑二: 基本游戏逻辑实现
- **目标:** 实现完整的海龟汤游戏流程。
- **任务:**
    1.  实现主持人创建房间、设定规则的UI。
    2.  实现主持人与多个参与者的连接管理。
    3.  实现基于JSON的数据协议，完成提问、回答、发布情报的核心逻辑。
    4.  实现聊天记录区和参与者列表的动态更新。
    5.  实现游戏结束逻辑。

### 里程碑三: 完善UI与用户体验
- **目标:** 优化界面，增加辅助功能。
- **任务:**
    1.  美化CSS样式。
    2.  增加个人笔记功能。
    3.  实现提问模式（自由/举手）和互动功能（鲜花/垃圾）。
    4.  增加断线重连的提示和基础处理。
    5.  进行全面的测试和Bug修复。 